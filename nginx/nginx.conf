events {
    # Maximum number of simultaneous connections that can be opened by a worker process
    worker_connections 2048;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ============================================================
    # SETTINGS (Buffers for Keycloak & Large Uploads)
    # Essential to prevent 502 Bad Gateway errors with large Headers/JWTs
    # ============================================================
    client_max_body_size 20M;
    proxy_buffer_size    128k;
    proxy_buffers        4 256k;
    proxy_busy_buffers_size    256k;

    # ============================================================
    # 1. HTTP REDIRECT (Port 80 -> 443)
    # Force all HTTP traffic to HTTPS
    # ============================================================
    server {
        listen 80;
        listen [::]:80;
        
        # ADDED GRAFANA SUBDOMAIN TO THE REDIRECT RULE
        server_name salem-dev.online auth.salem-dev.online grafana.salem-dev.online;

        # Allow Certbot to access the challenge files for renewal
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # Force redirect everything else to HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # ============================================================
    # 2. MAIN APP SERVER (SSL Enabled)
    # Domain: salem-dev.online
    # ============================================================
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name salem-dev.online;

        # SSL Certificates path (Mapped via Docker volumes)
        ssl_certificate /etc/letsencrypt/live/salem-dev.online/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/salem-dev.online/privkey.pem;

        # Angular Frontend Settings
        location / {
            proxy_pass http://notes_frontend_container:80;
            # Fallback to index.html for Angular routing

           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto https;

        }

        # Spring Boot Backend Settings
        location /api/ {
            # 'notes_backend_container' is the service name in docker-compose
            proxy_pass http://notes_backend_container:8080;

            # Forwarding headers to preserve client identity
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # CRITICAL: Tell Backend that the original request was HTTPS
            proxy_set_header X-Forwarded-Proto https;
        }
    }

    # ============================================================
    # 3. KEYCLOAK SERVER (SSL Enabled)
    # Domain: auth.salem-dev.online
    # ============================================================
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name auth.salem-dev.online;

        # Using the same wildcard/multi-domain certificate
        ssl_certificate /etc/letsencrypt/live/salem-dev.online/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/salem-dev.online/privkey.pem;

        location / {
            # 'notes_keycloak' is the service name in docker-compose
            proxy_pass http://notes_keycloak:8080;

            # Standard Forwarding Headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # CRITICAL for Keycloak Strict Mode & Secure Cookies
            proxy_set_header X-Forwarded-Proto https;
        }
    }

    # ============================================================
    # 4. GRAFANA OBSERVABILITY SERVER (SSL Enabled) 
    # Domain: grafana.salem-dev.online
    # ============================================================
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name grafana.salem-dev.online;

        # Using the same wildcard/multi-domain certificate
        ssl_certificate /etc/letsencrypt/live/salem-dev.online/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/salem-dev.online/privkey.pem;

        location / {
            # Route traffic to the internal Grafana port in the observability container
            proxy_pass http://observability:3000;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }
}